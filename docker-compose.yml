services:
  postgres:
    image: postgres:16
    restart: always
    environment:
      - POSTGRES_USER=medplum
      - POSTGRES_PASSWORD=medplum
    command:
      # We use command line args instead of a postgres.conf to avoid additional setup out of the box
      - 'postgres'
      - '-c'
      - 'listen_addresses=*'
      - '-c'
      - 'statement_timeout=60000'
      - '-c'
      - 'default_transaction_isolation=REPEATABLE READ'
      - '-c'
      - 'shared_preload_libraries=pg_stat_statements,auto_explain'
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U medplum']
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7
    restart: always
    command: redis-server --requirepass medplum
    ports:
      - '6379:6379'
    volumes:
      - redis_data:/data
    healthcheck:
      test: ['CMD', 'redis-cli', '-a', 'medplum', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5

  # Medplum server container
  medplum-server:
    image: medplum-server:local
    restart: always
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      # Conditionally define a volume for a `medplum.config.json` if one is specified by the MEDPLUM_CONFIG_PATH env var
      - ${MEDPLUM_CONFIG_PATH:-./medplum.config.json}:/usr/src/medplum/packages/server/medplum.config.json
      # Persistent storage for uploaded files (matches MEDPLUM_BINARY_STORAGE: 'file:./binary/')
      - medplum_storage:/usr/src/medplum/binary
    entrypoint: >
      sh -c "
      if [ -n '${MEDPLUM_CONFIG_PATH}' ]; then
        echo 'Config file found, running with custom config'
        node --require ./packages/server/dist/otel/instrumentation.js packages/server/dist/index.js file:/usr/src/medplum/packages/server/medplum.config.json
      else
        echo 'No config file found, running with default env settings'
        node --require ./packages/server/dist/otel/instrumentation.js packages/server/dist/index.js env
      fi
      "
    environment:
      MEDPLUM_PORT: 8103
      MEDPLUM_BASE_URL: 'https://healthai.appteon.ai/api/'
      MEDPLUM_APP_BASE_URL: 'https://healthai.appteon.ai/'
      MEDPLUM_STORAGE_BASE_URL: 'https://healthai.appteon.ai/api/storage/'

      MEDPLUM_DATABASE_HOST: 'postgres'
      MEDPLUM_DATABASE_PORT: 5432
      MEDPLUM_DATABASE_DBNAME: 'medplum'
      MEDPLUM_DATABASE_USERNAME: 'medplum'
      MEDPLUM_DATABASE_PASSWORD: 'medplum'

      MEDPLUM_REDIS_HOST: 'redis'
      MEDPLUM_REDIS_PORT: 6379
      MEDPLUM_REDIS_PASSWORD: 'medplum'

      MEDPLUM_BINARY_STORAGE: 'file:./binary/'
      MEDPLUM_SUPPORT_EMAIL: '\"Medplum\" <support@medplum.com>'
      MEDPLUM_GOOGLE_CLIENT_ID: '397236612778-c0b5tnjv98frbo1tfuuha5vkme3cmq4s.apps.googleusercontent.com'
      MEDPLUM_GOOGLE_CLIENT_SECRET: ''
      MEDPLUM_RECAPTCHA_SITE_KEY: '6Lfqjy0sAAAAAAfKiIBJSa_Rz8vFzdT4Q4PJ--mt'
      MEDPLUM_RECAPTCHA_SECRET_KEY: '6Lfqjy0sAAAAAK8ygOWcOwMM_-nc_01cuuuIcC4v'
      MEDPLUM_MAX_JSON_SIZE: '500mb'
      MEDPLUM_MAX_BATCH_SIZE: '500mb'
      MEDPLUM_BOT_LAMBDA_ROLE_ARN: ''
      MEDPLUM_BOT_LAMBDA_LAYER_NAME: 'medplum-bot-layer'
      MEDPLUM_VM_CONTEXT_BOTS_ENABLED: 'true'
      MEDPLUM_DEFAULT_BOT_RUNTIME_VERSION: 'vmcontext'
      MEDPLUM_ALLOWED_ORIGINS: '*'
      MEDPLUM_INTROSPECTION_ENABLED: 'true'
      MEDPLUM_SHUTDOWN_TIMEOUT_MILLISECONDS: 30000
      HEALTHSCRIBE_MODEL: 'llama'
      # HEALTHSCRIBE_MODEL: 'llama,openai,xai'
      SONIOX_API_KEY: '8c4837b2e36f0af9866280e3243aa4dc6ce7bd33ceb5804ce8ab458a2fb0920d'
      
      # Pre-chart scheduler settings
      PRECHARTSCHEDULER_ENABLED: 'true'
      PRECHARTSCHEDULER_INTERVAL_MS: '1800000'  # 30 minute (default)
      # PRECHARTSCHEDULER_INTERVAL_MS: '60000'  # 1 minute (testing)

      # EHR Bulk Data Sync settings
      # Works with any EHR supporting FHIR Bulk Data Export (Epic, Cerner, Practice Fusion, etc.)
      # Switch between configurations by commenting/uncommenting the relevant section below
      EHR_SYNC_ENABLED: 'true'
      EHR_SYNC_INTERVAL_MS: '86400000'  # 24 hours (default)
      # EHR_SYNC_INTERVAL_MS: '60000'  # 1 minute (testing)
      EHR_SYNC_RUN_ON_STARTUP: 'true'  # Run initial sync on startup
      EHR_TARGET_PROJECT_ID: 'acd7d2ce-9b81-4a3b-9238-179ffd45e545'  # HealthAI project

      # ========== OPTION 1: Epic Sandbox (CURRENTLY ACTIVE) ==========
      # Uses JWT authentication with private key
      EHR_FHIR_BASE_URL: 'https://fhir.epic.com/interconnect-fhir-oauth/api/FHIR/R4'
      EHR_CLIENT_ID: 'f0bd04ce-c3da-4b3c-ae97-365f5848f4e6'
      EHR_GROUP_ID: 'e3iabhmS8rsueyz7vaimuiaSmfGvi.QwjVXJANlPOgR83'  # Required for Epic bulk export
      EHR_IDENTIFIER_SYSTEM: 'https://open.epic.com/fhir'
      EHR_PRIVATE_KEY: |
        -----BEGIN PRIVATE KEY-----
        MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDInf/bWBwH8q3i
        GJoMbUyN9oskV9zeR8y+QAsI0znGdMAFuyjMdMp2dppdiSxF+aGBoATI5Cu+rNys
        1QKEoCx+3hIus3JOaHcVnlL+S7bLJULa8tM/jzkjnZ31sMkySHZlfewIXbxUgylR
        8OTBPG+OQ8f+Ufa9jsjNdMkE62McAgukCyf6/i1Dk1CLexZQbQ69F3FJmmdlgsCx
        Hgz2mUUM0+Q00TSDbtEnezmUd9RtULmbjMzgcX0vUNnVB80LzMfaeqm4BulPlLA+
        2IDbOJc+VgClq9ddwi2zKH6/eztQh0Yf0TfsbEmUqsjmuL2dSnWMmBNe5mevA0mG
        j6jLlwQBAgMBAAECggEAIczbAXf2GxG0YbJO7BaTLhzygwBJrmqu8IPmSAmcg5cC
        jkSjAlWQEgb4CZfVrYF6SFZvT/B/fUvvDzCBUNqSvJpKOnOR5+t6WtpWtdEIXnAr
        9Csy09Pb5ugEp9MuBsqGJiHh3WP7mcqScOOTCwqVagT6AluJZJUUuGb7glhtVZen
        QDITNVf6apPYgFenVmWqLx0JoCQMjNnJlowCIopPQ8U2B1hcRWrZt7NvWmB7DL9f
        xHxQu6EiEkFI6CMz1N2dYVdfN7W/1OYeDjS7dxypWiWenMjTgT3dsuMLIEMM0AgT
        ng6p8o87Y/yjVFnv6SZv12Kl87LdFx4VjuOXcRqkVQKBgQDnfDdIJFjerfLw7cyD
        U4QcDhZDpdwU3PSSjUneeB2cWCcItY8ez8jqNxbLnCXpirTMLrWqUTOXJqdfLy8V
        kOboYUtLzFNrtGNdvHdz+BQN7CYrahQR/FWnQEwFpCgYj94xf4506kyxwzcAdIGp
        /XTYyPLcFjPrDj+QNWlwLx+XLQKBgQDd3Ov7oJMZ1oI20Wu9cZw41wckjwSer50k
        P+0uoFKLn9yX+GOrw6d/rE0O4FtMJUjK3aNRXuwQO45MCuOM7cAjz7dYDZYdWHfb
        a1It3YjtWCtOT7xrW8UUpXfGk8VpXBrlkcr0XQhJqcVc24904dy96q7S8ap/sFW4
        STALNgFkpQKBgQCoXp0HCAjrzrIJs60xSCmrDkP7aEQvmJb7kXDNM6i18xhRKV20
        F4YXdYJLDoQ03gKrEL5p5y4THrZWcUdZ9E8/bqUJuNBkYoxzvYVVAHf1uHH62elH
        O7ZBNG8XG1NeqiX+8rx3JYQrN8ZlulglgIjgtSiQFEYnDfIFvhO22U+s8QKBgQDS
        wXqqne8fLFamHGpsm+/7TsjKQdHxrIFqXg/Bqyq+2C2Fb7+++y2yassIxrfzrbdo
        fwMV2UYGZYzXT8C5r2BGpJtWWhGv7sps9ZYrW7cnQApjaftjQNoGsukFCnsNiyFB
        0y0o1Pd6gnupqiisr6IyBy3r1QZSJgBH/75T6AmKwQKBgGDmGn0lnt0TI9+6wvWH
        bEPyQ2YcRG9fzskFkIvUQrDYRiARDO+9tYYNgmg7O41xOyFbQE3BBoPBpQiagAcc
        53BPvjt8WTTAsEL0fpg+v3Vy07Do2+A+rMnCQ7lw+zE6BU01v4ZF9mtQTRPNu8n5
        3iLf90E0eefIqgZ/1OXAxPrt
        -----END PRIVATE KEY-----
      EHR_KEY_ID: 'fpjEcqpWKazjMCPu'  # From your JWKS
      # Epic-specific scopes for bulk data export
      EHR_SCOPES: 'system/Patient.read system/AllergyIntolerance.read system/Binary.read system/CarePlan.read system/Condition.read system/DiagnosticReport.read system/DocumentReference.read system/Encounter.read system/Immunization.read system/Medication.read system/MedicationRequest.read system/MedicationStatement.read system/Observation.read system/Practitioner.read system/ServiceRequest.read'
      # Comment out client_secret when using Epic:
      # EHR_CLIENT_SECRET: ''

      # ========== OPTION 2: Practice Fusion Sandbox ==========
      # Uncomment these lines and comment out Epic configuration above to switch
      # Uses client_secret authentication (simpler)
      # EHR_FHIR_BASE_URL: 'https://api-sandbox.practicefusion.com/fhir/r4/v1'
      # EHR_CLIENT_ID: '5d068de1-4cb1-45bf-b9ff-09fa51669ef8'
      # EHR_CLIENT_SECRET: '4uRSYIg0f955uhwG480npbBiwk3argUkck5IKH+eC68='
      # EHR_IDENTIFIER_SYSTEM: 'https://practicefusion.com/fhir'
      # Comment out these when using Practice Fusion (doesn't need them):
      # EHR_GROUP_ID: ''
      # EHR_PRIVATE_KEY: ''
      # EHR_KEY_ID: ''

      # Resource types to export from EHR
      EHR_RESOURCE_TYPES: 'Patient,AllergyIntolerance,Binary,CarePlan,Condition,DiagnosticReport,DocumentReference,Encounter,Immunization,Medication,MedicationRequest,MedicationStatement,Observation,Practitioner,ServiceRequest'

    healthcheck:
      test:
        # We use Node's fetch for healthcheck because this image doesn't have a curl or wget installed
        [
          'CMD',
          'node',
          '-e',
          'fetch("http://127.0.0.1:8103/healthcheck").then(r => r.json()).then(console.log).catch(() => { process.exit(1); })',
        ]
      interval: 30s
      timeout: 10s
      retries: 5

  # Medplum app container (web UI)
  medplum-app:
    image: medplum-app:local
    restart: always
    depends_on:
      medplum-server:
        condition: service_healthy
    environment:
      # This is read by the app's entrypoint to configure API base URL
      MEDPLUM_BASE_URL: 'https://healthai.appteon.ai/api/'
      RECAPTCHA_SITE_KEY: '6Lfqjy0sAAAAAAfKiIBJSa_Rz8vFzdT4Q4PJ--mt'
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://127.0.0.1:3000']
      interval: 10s
      timeout: 5s
      retries: 5

  # Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: medplum-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      medplum-app:
        condition: service_healthy
      medplum-server:
        condition: service_healthy
    restart: always

volumes:
  postgres_data:
  redis_data:
  medplum_storage:
